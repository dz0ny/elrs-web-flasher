"use strict";(self.webpackChunkflasher=self.webpackChunkflasher||[]).push([[181],{9181:(t,e,r)=>{r.r(e),r.d(e,{MelodyParser:()=>o});class a{static parse(t){const e=t.split(":");if(3!==e.length)throw new Error("Invalid RTTTL file.");const r=a.getName(e[0]),n=a.getDefaults(e[1]);return{name:r,defaults:n,melody:a.getData(e[2],n)}}static toBluejayStartupMelody(t,e){let r=a.parse(t);if((e="number"==typeof e?e:128)<4)throw new Error("startupMelodyLength is too small to fit a Bluejay Startup Melody");const n=256;let o=r.melody,l=new Uint8Array(e),c=new Array(o.length),u=Math.floor(r.defaults.bpm)%65536;l[0]=u>>8&255,l[1]=255&u,l[2]=Math.floor(r.defaults.octave)%n,l[3]=Math.floor(r.defaults.duration)%n;for(var s=4,i=0;i<o.length&&s<l.length;){var h=o[i];if(0!=h.frequency){let t=a._calculateBluejayTemp3FromFrequency(h.frequency);if(t>0&&t<n){let e=1e3/h.frequency,r=Math.round(h.duration/e);for(;r>0&&s<l.length;)l[s++]=Math.min(r,255),l[s++]=t,r-=l[s-2];c[i]=r>0?2:0}else c[i]=1}else{let t=Math.round(h.duration);for(;t>0&&s<l.length;)l[s++]=Math.min(t,255),l[s++]=0,t-=l[s-2];c[i]=t>0?2:0}i++}for(;i<o.length;)c[i]=2,i++;return{data:l,errorCodes:c}}static fromBluejayStartupMelody(t,e){if(e=e||"Melody",t.length<4)return e+"Melody:d=1,o=4,bpm=100:";let r=(t[0]<<8)+t[1],n=t[2],o=t[3],l=[];for(var c=4;c+1<t.length;c+=2){const e=a._calculateFrequencyFromBluejayTemp3(t[c+1]),r=a._calculateNoteNameFromFrequency(e),n=a._calculateNoteOctaveFromFrequency(e),o=0==e?t[c]:1e3/a._calculateFrequency(r,n)*t[c];if(!(o>0))break;l.length>0&&Math.abs(l[l.length-1].frequency-e)<.01&&255===t[c-2]?l[l.length-1].duration+=o:l.push({duration:o,frequency:e,musicalNote:r,musicalOctave:n})}const u=24e4/r;let s=u/64,i="";for(var h of l){let t=(f=h.duration,Math.round(f/s)*s/u);for(;t>1/64;){let e=Math.min(1.5,t),r=Math.pow(2,-Math.floor(Math.log2(e))),a=e*r>1;i+=(r===o?"":r)+h.musicalNote+(h.musicalOctave===n||0===h.musicalOctave?"":h.musicalOctave)+(a?".":"")+",",t-=e}}var f;return e+":b="+r+",o="+n+",d="+o+":"+i.replace(/,$/,"")}static getName(t){return t.length>10&&console.warn("Tune name should not exceed 10 characters."),t||"Unknown"}static getDefaults(t){const e=t.split(",").map((t=>{if(""===t)return{};const e=t.split("=");if(2!==e.length)throw new Error("Invalid setting "+t);const r=e[0],a=e[1],n=["1","2","4","8","16","32"],o=["4","5","6","7"],l=["25","28","31","35","40","45","50","56","63","70","80","90","100","112","125","140","160","180","200","225","250","285","320","355","400","450","500","565","635","715","800","900"];switch(r){case"d":if(-1!==n.indexOf(a))return{duration:a};throw new Error("Invalid duration "+a);case"o":return-1===o.indexOf(a)&&console.warn("Invalid octave "+a),{octave:a};case"b":return-1===l.indexOf(a)&&console.warn("Invalid BPM "+a),{bpm:a}}})),r=a._toObject({},e);return Object.assign({duration:"4",octave:"6",bpm:"63"},r)}static _toObject(t,e){if(0===e.length)return t;const r=Object.assign(t,e[0]);return a._toObject(r,e.slice(1))}static getData(t,e){const r=t.split(","),n=6e4/parseInt(e.bpm);return r.map((t=>{const r=t.match(/(1|2|4|8|16|32|64)?((?:[a-g]|h|p)#?){1}(\.*)(1|2|3|4|5|6|7|8)?(\.*)/),o=r[1]||parseInt(e.duration),l="h"===r[2]?"b":r[2],c=r[4]||parseInt(e.octave),u=r[3]&&"."===r[3][0]?r[3].length:r[5]&&"."===r[5][0]?r[5].length:0;return{note:l,duration:a._calculateDuration(n,parseFloat(o),u),frequency:a._calculateFrequency(l,c)}}))}static _calculateFrequency(t,e){if("p"===t)return 0;const r=Math.pow(2,1/12),n=a._calculateSemitonesFromC4(t,e),o=261.63*Math.pow(r,n);return Math.round(10*o)/10}static _calculateSemitonesFromC4(t,e){const r=12*(e-4);return["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"].indexOf(t)+r}static _calculateNoteNameFromFrequency(t){if(0===t)return"p";const e=Math.round(12*Math.log2(t/261.63));return["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"][e<0?12+e%12:e%12]}static _calculateNoteOctaveFromFrequency(t){if(0===t)return 0;let e=Math.round(12*Math.log2(t/261.63));return 4+Math.floor(e/12)}static _calculateDuration(t,e,r){return 4*t/e*(4===r?1.9375:3===r?1.875:2===r?1.75:1===r?1.5:1)}static _calculateBluejayTemp3FromFrequency(t){return 0===t?0:Math.round(1e6/(24.72*t)-399.3/24.72)}static _calculateFrequencyFromBluejayTemp3(t){return 0===t?0:1e6/(24.72*t+399.3)}}const n=a;class o{static#t=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"];static#e(t,e=0,r=440){const a=3===t.length?Number(t[2]):Number(t[1]);let n=this.#t.indexOf(t.slice(0,-1));return n=n<3?n+12+12*(a-1)+1:n+12*(a-1)+1,n+=e,Math.floor(r*2**((n-49)/12))}static#r(t,e){return Math.floor(240/t*1e3/e)}static#a(t,e=120,r=0){const a=t.split(" "),n=[];for(let t=0;t<a.length;t++){const o=a[t],l=a[t+1];if(console.log(o,l),"P"===o[0])n.push([0,this.#r(e,o.substring(1))]);else if(-1!=="ABCDEFG".indexOf(o[0])){const t=this.#e(o,r),a=this.#r(e,l);n.push([t,a])}}return n}static parseToArray(t){if(-1!==t.indexOf("|")){const e=t.split("|"),r=e.length>2?Number(e[2]):0;return this.#a(e[0].trim(),Number(e[1]),r)}{const e=n.parse(t).melody.map((t=>[Math.floor(t.frequency),Math.floor(t.duration)]));return e.length>32&&(e.length=32),e}}}}}]);